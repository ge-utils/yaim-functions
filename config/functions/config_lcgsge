##############################################################################
# Copyright (c) Members of the EGEE Collaboration. 2004.
# See http://www.eu-egee.org/partners/ for details on the copyright holders.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
##############################################################################
#
# NAME        : config_lcgsge
#
# DESCRIPTION : This function implements the lcgsge Job Manager for lcg-CE 3.1
#
# AUTHORS     : goncalo@lip.pt
#
# NOTES       : - Tested in SGE V60u7_1, V61u3
#             : - Configures the SGE infoprovider and SGE JobManager
#
# YAIM MODULE : glite-yaim-sge-utils
#
##############################################################################


function config_lcgsge_check(){
    requires $1 SGE_ROOT SGE_CELL
    return $?
}


function config_lcgsge_setenv(){
    return 0
}


function config_lcgsge(){

INSTALL_ROOT=${INSTALL_ROOT:-/opt}

yaimlog DEBUG "###"
yaimlog DEBUG "### Get gLite version "
yaimlog DEBUG "###"

glite_version=`echo /opt/glite/bin/glite-version | cut -d '.' -f1-2`
if [ "X$glite_version" == "X3.1" ]; then
   yaimlog INFO "Running JobManager SGE configuration for gLite version >= 3.1"
elif [ "X$glite_version" == "X" -or "X$glite_version" != "3.1" ]; then 
   yaimlog ABORT "gLite version not supported. Exiting..."  
   exit 1
fi

#---*---

yaimlog DEBUG "###"
yaimlog DEBUG "### Build JobManager configuration files"
yaimlog DEBUG "### Fully based on CESGA implementation"
yaimlog DEBUG "###"

yaimlog INFO \ 
yaimlog INFO " Building SGE JobManager configuration files"

SGE_JOBMANAGER=$INSTALL_ROOT/globus/lib/perl/Globus/GRAM/JobManager/lcgsge.pm
if [ ! -e ${SGE_JOBMANAGER} ]; then
   yaimlog ABORT " ${SGE_JOBMANAGER} is not installed !!! Without it job management will not work!!! Exiting..."
   exit 1
fi

#---*---

yaimlog DEBUG "###"
yaimlog DEBUG "### SGE JM configuration file"
yaimlog DEBUG "###"

SGE_JOBMANAGER_CONF=$INSTALL_ROOT/globus/lib/perl/Globus/GRAM/JobManager/lcgsge.conf
yaimlog INFO " Installing SGE Job manager configuration files" 
if [ -e ${SGE_JOBMANAGER_CONF} ]; then
   count=`ls -tr ${SGE_JOBMANAGER_CONF}.OLD* 2>/dev/null | tail -n 1 | cut -f4 -d"."`
   if [ "X$count" == "X" ]; then
       count=0
   else
       count=`expr $count + 1`
   fi
   # yaimlog WARNING " ${SGE_JOBMANAGER_CONF} exists. Your old file will be saved as ${SGE_JOBMANAGER_CONF}.OLD.${count}"
   mv -f ${SGE_JOBMANAGER_CONF} ${SGE_JOBMANAGER_CONF}.OLD.${count}
fi
cat <<EOF_SGE_JOBMANAGER_CONF > ${SGE_JOBMANAGER_CONF}
# SGE JM Configuration File
#
# SGE paths
\$SGE_BASE_PATH    = '$SGE_ROOT';
\$SGE_BIN_PATH     = '$SGE_ROOT/bin/$ARCH';
# Default values for SGE required complex values
# In case SGE forces to specify a given set of parameters you can
# specify the default values in this section
# If you don't need to define some parameter you should to set it
# to an empty string or to 0. 
# Parameters that could be availables in the jdl file
# These values are only use in case a value is not specified
# in the jdl file
# max cpu time
#\$S_RT           = '10:00:00';
\$S_RT            = '';
# max memory
#\$S_VMEM         = '512M';
\$S_VMEM          = '';
# number of processors
#\$NUM_PROC       = 1;
\$NUM_PROC        = 0;
# Extra parameters not available in the jdl file.
#\$EXTRA          = 'h_fsize=5G,s_cpu=0:10:0';
\$EXTRA          = '';
EOF_SGE_JOBMANAGER_CONF

if [ "X$count" != "X" ]; then 
   diff ${SGE_JOBMANAGER_CONF}.OLD.${count} ${SGE_JOBMANAGER_CONF} > /dev/null 2>&1 
fi
if [ $? == 0 ]; then
     rm -f ${SGE_JOBMANAGER_CONF}.OLD.${count}
else
     yaimlog WARNING " ${SGE_JOBMANAGER_CONF} exists. Your old file will be saved as ${SGE_JOBMANAGER_CONF}.OLD.${count}"
fi
count=""

}

